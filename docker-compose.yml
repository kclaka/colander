services:
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.rust
      args:
        BINARY: demo-backend
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5

  proxy:
    build:
      context: .
      dockerfile: docker/Dockerfile.rust
      args:
        BINARY: proxy-server
    ports:
      - "8080:8080"
      - "9090:9090"
      - "6379:6379"
    volumes:
      - ./docker/config.toml:/config.toml:ro
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9090/api/stats || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  loadgen:
    build:
      context: .
      dockerfile: docker/Dockerfile.rust
      args:
        BINARY: loadgen
    command:
      - --proxy-url=http://proxy:8080
      - --control-addr=0.0.0.0:9091
      - --concurrency=16
      - --alpha=0.8
      - --num-items=100000
    ports:
      - "9091:9091"
    depends_on:
      proxy:
        condition: service_healthy

  dashboard:
    build:
      context: ./dashboard
      dockerfile: ../docker/Dockerfile.dashboard
    ports:
      - "3001:3001"
    depends_on:
      - proxy
      - loadgen
